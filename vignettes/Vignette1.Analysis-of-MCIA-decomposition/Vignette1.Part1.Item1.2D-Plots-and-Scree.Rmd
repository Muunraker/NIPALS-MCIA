---
header-includes:
   - \usepackage{amsmath}
   - \usepackage{amsfonts}
output:
  html_document: default
---

\newcommand{\mb}[1]{\mathbf{#1}}
\newcommand{\var}{\text{var}}
\newcommand{\cov}{\text{cov}}

```{r setup-V1-P1-I1, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(42) # NIPALS starts with a random vector
```

```{r, echo=FALSE, include=FALSE}
library(nipalsMCIA)
```

<!-- Loading NCI60 data and running nipals_multiblock()
    whenever running from individual Rmarkdowns -->
```{r child="Load-Shared-Vars.Rmd", include=FALSE}
```


## Part 1: Interpreting Global Factor Scores<br/>

### nipals_multiblock() Generates Basic Visualizations
In the introduction we showed how to calculate the MCIA decomposition using
`nipals_multiblock()` but used the parameter `plots='none'` to avoid the default
plotting behavior of this function. By default, this function will generate two
plots which help establish an initial intuition for the MCIA decomposition.
Here we will re-run `nipals_multiblock()` and omit the `plots` parameter
(default=all):
```{r, warning=FALSE, message=FALSE, fig.height=4, fig.width=8, fig.align='center'}
set.seed(42)
mcia_results <- nipals_multiblock(data_blocks, preprocMethod = "colprofile",
                                  num_PCs = 10, tol = 1e-12)
```

The first plot visualizes each sample using factor 1 and 2 as a lower
dimensional representation (Factor plot). Each sample is actually represented by
4 points, a center point (solid block dot) which represents to global factor
score, a mRNA factor score (square), a miRNA factor score (circle), and a
protein factor score (triangle). The last three omic-specific block factor
scores are connected to the global factor point by lines. If a block factor
scores is plotted far from its corresponding global factor score then this is
an indication that the block does not agree with/contribute to the trend found
by the global decomposition but can also be an proxy for batch effects within
a particular block if points from a block are consistently far away from their
global point. As an example, we can take a look at the global factor score at
$(-1.1, 0.4)$, the block factor scores are all quite near which suggests all
three omics are contributing somewhat equally, this is contrast to the global
factor score at $(-0.3, 0.9)$ where the mRNA factor score is close but the
mRNA and miRNA are far from their respective global factor score.

The second plot is a scree plot of singular values corresponding to global
factors, higher values assign a greater importance and can be interpreted
exactly the same as an eigenvalue scree plot in principal component analysis.

### Visualizing a Factor Plot with Only Global Factor Scores
For clustering, it is useful to look at global factor scores without block
factor scores. The `projection_plot()` function can be used to generate such a plot
using `plotType="projection_global"` as show below:

```{r Visualize Clusters, fig.height=4, fig.width=4, fig.align='center'}
projection_plot(mcia_results, "projection_global", orders = c(1,2))
```

In addition, factor plots are most helpful when points are colored by a
meaningful label such as cancer type. The `projection_plot()` function can include
such data using the `metadata` argument. The `metadata` arguments requires a
data frame where rows are samples and columns are different labels, allowing
for a variety of visualization objectives/explorations. For instance, each of
the 21 samples in the NCI-60 dataset represents a patient with one of three
cancer types: CNS, Leukemia, or Melanoma. We have provided this metadata 
as part of the `data(NCI60)` datasets and can be found as `metadata_NCI60`: 
```{r}
metadata_NCI60
```

In order to use this data it must be converted into a data frame and passed as
part of the `metadata` argument of `nipals_multiblock()` or added directly to `mcia_results`:

```{r, warning=FALSE, message=FALSE}
# Conversion of metadata to data frame 
metadata_NCI60 <- data.frame(cancerType = unlist(metadata_NCI60))
row.names(metadata_NCI60) <- rownames(data_blocks[[1]])

# Adding metadata as part of the nipals_multiblock() function
set.seed(42)
mcia_results <- nipals_multiblock(data_blocks, preprocMethod = "colprofile", 
                                  metadata = metadata_NCI60, plots = "none",
                                  num_PCs = 10, tol = 1e-12)

# Alternative method for adding metadata
mcia_results$metadata <- metadata_NCI60
```

The `color_col` argument of `projection_plot()` can then be used to determine which column of `metadata` is used for color_col the projection plots, in this case the column is `cancerType`:
```{r Visualize Clusters color_col, fig.height=4, fig.width=4, fig.align='center'}
projection_plot(mcia_results, "projection_global", orders = c(1,2),
                color_col = "cancerType", legend_loc = "bottomleft")
```

Clusters of samples can be computed from the global factor scores using any method, such as k-means clustering and visualized similarly.