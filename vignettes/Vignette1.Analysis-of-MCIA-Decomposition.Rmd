---
title: "Analysis of MCIA Decomposition"
author: "Max Mattessich, Joaquin Reyna, Edel Aron, Anna Konstorum"
date: "Compiled: `r format(Sys.time(), '%d %B %Y')`"
header-includes:
   - \usepackage{amsmath}
   - \usepackage{amsfonts}
output:
    rmdformats::readthedown:
      code_folding: show
      df_print: kable
      highlight: kate
      toc_depth: 4
vignette: >
  %\VignetteIndexEntry{Analysis-of-MCIA-Decomposition}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

\newcommand{\mb}[1]{\mathbf{#1}}
\newcommand{\var}{\text{var}}
\newcommand{\cov}{\text{cov}}

```{r setup-merger, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(42) # NIPALS starts with a random vector
```

```{r libraries, echo = FALSE, include = FALSE}
library(ComplexHeatmap)
library(dplyr)
library(fgsea)
library(ggplot2)
library(ggpubr)
library(nipalsMCIA)
library(stringr)
```

## Introduction

In the mini-lectures, we covered in detail the math behind MCIA as well as a
generic pipeline. In this vignette, we will cover the most important functions
within the nipalsMCIA package as well as downstream analyses that help can
interpret the MCIA decomposition. MCIA is applicable to any kind of multi-block
data.

For this vignette, we are using a cancer data set from
[Meng et al., 2016](https://doi.org/10.1093/bib/bbv108) that includes 21
subjects with three data blocks. The data blocks include mRNA levels
(12895 features), microRNA levels (537 features) and protein levels
(7016 features). Without a multi-block method, researchers may try to use
feature reduction methods on each block individually, but this strategy ignores
relationships between different blocks or under-appreciates signals which are
specific to one block.

In the context of the NCI60 data set and this vignette, we will show you the
power of MCIA to find important relationships between mRNA, microRNA and
proteins. More specifically, we will show you how to interpret the global
factor scores in [Part 1: Interpreting Global Factor Scores] and global loadings
in [Part 2: Interpreting Global Loadings].

**Preview of the NCI60 dataset**

The NCI60 data set has been included with the `nipalsMCIA` package and is
easily available as shown below:

```{r intro-load-data}
# load the dataset which uses the name data_blocks
data(NCI60)

# examine the contents
data_blocks$miRNA[1:5, 1:3]
data_blocks$mrna[1:5, 1:3]
data_blocks$prot[1:5, 1:3]
```

One important detail is the use of a suffix at the end of each variable name;
this is used later downstream to extract omics specific datasets from the
global loadings and scoring matrices.

**Running and reviewing the MCIA output**

We can compute the MCIA decomposition for any number of global factors with the
specific constraint that $r$ is (much) less than the number of features in the
omics with the fewest features (i.e. $r << min(p_b)$). Here we are calculating
the first 10 global factors by using:

```{r intro-mcia, warning = FALSE, message = FALSE}
mcia_results <- nipals_multiblock(data_blocks, preproc_method = "colprofile",
                                  num_PCs = 10, tol = 1e-12, plots = "none")
```

The results is a list of various decomposition matrices for MCIA and few other
values:

```{r intro-mcia-results}
names(mcia_results)
```

`global_scores` refers to $f^{(j)}$'s, `global_loadings` to $a^{(j)}$'s,
`block_score_weights` to $G$, `block_scores` to $f_k^{(j)}$'s, `block_loadings`
$a_k^{(j)}$'s, `eigvals` to $e$, `preproc_method` to the pre-processing method
used and `metadata` to any sample meta-data that has been passed. More details
on each of the matrices are covered as part of the math mini-lecture, however we
will briefly review the `global_scores` and `global_loadings`.

**Brief overview of the Global Scores Matrix F**

The `global_scores` matrix is represented by $\mb F$ with dimensions
$n \times r$, where $n$ is the number of samples and $r$ is the number of
factors chosen by using the `num_PCs = r` argument. Each column of this matrix
represents an order of the global factors, i.e.

$$
\mb F = \begin{pmatrix}
    | & |&  & |\\
    \mb f^{(1)} &\mb f^{(2)} & \dots & \mb f^{(r)}\\
    | & |&  & |
  \end{pmatrix} \in \mathbb{R}^{n \times r}
$$

This matrix encodes a low-dimensional representation of the data set, with the
$i$-th row representing a set of $r$-dimensional coordinates for the $i$-th
sample.

**Brief overview of the Global Loadings Matrix A**

The `global_loadings` matrix is represented by $\mb A$ that is $p \times r$,
where $p$ is the number of features across all omics and $r$ is as before.
Each column of this matrix represents one of the orders of global loadings,
i.e.

$$
\mb A = \begin{pmatrix}
    | & |&  & |\\
    \mb a^{(1)} &\mb a^{(2)} & \dots & \mb a^{(r)}\\
    | & |&  & |
  \end{pmatrix} \in \mathbb{R}^{p \times r}
$$

This matrix encodes the contribution of each feature to the  low-dimensional
representation.

The remainder of this vignette will be broken down into two sections,
[Part 1: Interpreting Global Factor Scores] and [Part 2: Interpreting Global Loadings]
where we show how to interpret $\mb F$ and $\mb A$, respectively.

## Part 1: Interpreting Global Factor Scores

### nipals_multiblock() Generates Basic Visualizations

In the introduction we showed how to calculate the MCIA decomposition using
`nipals_multiblock()` but used the parameter `plots = "none"` to avoid the
default plotting behavior of this function. By default, this function will
generate two plots which help establish an initial intuition for the MCIA
decomposition. Here we will re-run `nipals_multiblock()` and omit the `plots`
parameter (default=all):

```{r part-1-mcia, warning = FALSE, message = FALSE, fig.dim = c(8, 4), fig.align = 'center'}
set.seed(42)

mcia_results <- nipals_multiblock(data_blocks, preproc_method = "colprofile",
                                  num_PCs = 10, tol = 1e-12)
```

The first plot visualizes each sample using factor 1 and 2 as a lower
dimensional representation (factor plot).

- Each sample is actually represented by 4 points, a center point (solid block
dot) which represents to global factor score, a mRNA factor score (square), a
miRNA factor score (circle), and a protein factor score (triangle).
- The last three omic-specific block factor scores are connected to the global
factor point by lines. If a block factor scores is plotted far from its
corresponding global factor score, then this is an indication that the block
does not agree with/contribute to the trend found by the global decomposition
but can also be an proxy for batch effects within a particular block if points
from a block are consistently far away from their global point.
- As an example, we can take a look at the global factor score at $(-1.1, 0.4)$.
The block factor scores are all quite near which suggests all three omics are
contributing somewhat equally. This is in contrast to the global factor score at
$(-0.3, 0.9)$ where the mRNA factor score is close, but the mRNA and miRNA are
far from their respective global factor score.

The second plot is a scree plot of singular values corresponding to global
factors; higher values assign a greater importance and can be interpreted
exactly the same as an eigenvalue scree plot in principal component analysis.

### Visualizing a Factor Plot with Only Global Factor Scores

For clustering, it is useful to look at global factor scores without block
factor scores. The `projection_plot()` function can be used to generate such a
plot using `projection = "global"` as show below:

```{r part-1-visualize-clusters, fig.dim = c(8, 8), fig.align = 'center'}
projection_plot(mcia_results, "global", orders = c(1, 2))
```

In addition, factor plots are most helpful when points are colored by a
meaningful label such as cancer type. The `projection_plot()` function can
include such data using the `metadata` argument. The `metadata` arguments
requires a data frame where rows are samples and columns are different labels,
allowing for a variety of visualization objectives/explorations. For instance,
each of the 21 samples in the NCI-60 dataset represents a patient with one of
three cancer types: CNS, Leukemia, or Melanoma. We have provided this metadata
as part of the `data(NCI60)` datasets and can be found as `metadata_NCI60`:

```{r part-1-metadata}
metadata_NCI60
```

In order to use this data it must be converted into a data frame and passed as
part of the `metadata` argument of `nipals_multiblock()` or added directly to
`mcia_results`:

```{r part-1-mcia-again, warning = FALSE, message = FALSE}
set.seed(42)

# adding metadata as part of the nipals_multiblock() function
mcia_results <- nipals_multiblock(data_blocks, preproc_method = "colprofile",
                                  metadata = metadata_NCI60, plots = "none",
                                  num_PCs = 10, tol = 1e-12)

# alternative method for adding metadata
mcia_results$metadata <- metadata_NCI60
```

The `color_col` argument of `projection_plot()` can then be used to determine
which column of `metadata` is used for color_col the projection plots, in this
case the column is `cancerType`. `color_pal` can then be used with a character
vector or `scales::<function>` to select the colors which are applied
alphabetically:

```{r part-1-visualize-clusters-color-col, fig.dim = c(8, 8), fig.align = 'center'}
# meta_colors = c('orange', 'purple', 'pink')
meta_colors <- get_metadata_colors(mcia_results, 1)

projection_plot(mcia_results, "global", orders = c(1, 2),
                color_col = "cancerType", color_pal = meta_colors,
                legend_loc = "bottomleft")
```

Clusters of samples can be computed from the global factor scores using any
method, such as k-means clustering and visualized similarly.

### Visualizing the Clustering of Samples by Factor Scores

The global scores represent data from our samples projected down into our 
lower dimensional space $r$. Now that MCIA has compressed our data into 
these lower dimensions we can make a heatmap for samples versus factors to
begin mining patterns and relationships. To facilitate this process you can
visual a global scores heatmap using using `global_scores_heatmap()`:

```{r part-1-global-heatmap, fig.dim = c(8, 6), fig.align = 'center'}
global_scores_heatmap(mcia_results)
```

In the heatmap above, the samples have been hierarchically clustered. To
further understand these clusters, it is useful to add some `color_col` which
is available through the `color_col` + `color_pal` parameters as shown below:

```{r part-1-global-heatmap-colored, fig.dim = c(8, 6), fig.align = 'center'}
global_scores_heatmap(mcia_results,
                      color_col = "cancerType", color_pal = meta_colors)
```

This second heatmap allows us to see that global factor scores can successfully
encode and find differences between cancer types. For these results, it is
interesting to see that factor 1 alone can discern cancer type fairly well.

## Part 2: Interpreting Global Loadings

In addition to the global scores matrix, MCIA also calculates a global loadings
matrix $A$ that is $p\times r$.

### Pseudoeigenvalues Representing the Contribution of Each Omic to the Global Factor Score

```{r part-2-block-heatmap, fig.dim = c(8, 4), fig.align = 'center'}
block_weights_heatmap(mcia_results)
```

### Visualize All Feature Loadings on Two Axes

MCIA returns feature loadings for each factor that can be used to understand
important contributions of multi-omic features to a given factor.
To get a sense of which omics features show highest contribution to
each factor, one can plot feature loadings for any two omics using the
`vis_load_plot` function.

```{r part-2-loadings}
# colors_omics = c('red', 'blue', 'green')
# colors_omics <- get_colors(mcia_results, color_pal = colors_omics)
colors_omics <- get_colors(mcia_results)

vis_load_plot(mcia_results, axes = c(1, 4), colors_omics = colors_omics)
```

### Scree Plot: Visualizing the Top Features per Factor

For a given factor, users can return and visualize a ranked list of top
magnitude features. Features can be ranked based on the users preference:
either by absolute value, ascending, or descending values. All features, or
features in a given omic can be ranked. The `ord_loadings` function returns a
ranked list, and `vis_load_ord` allows users to visualize the features loadings
as a scree plot.

#### Factor 1

Here, we return and visualize two ranked lists for Factor 1: using all omics, or just mrna.

```{r part-2-factor-1, fig.dim = c(10, 5)}
# define the loadings
all_pos_1 <- ord_loadings(mcia_out = mcia_results, omic = "all",
                          absolute = FALSE, descending = TRUE, factor = 1)
mrna_pos_1 <- ord_loadings(mcia_out = mcia_results, omic = "mrna",
                           absolute = FALSE, descending = TRUE, factor = 1)

# visualization
all_pos_1_vis <- vis_load_ord(gl_f_ord = all_pos_1, omic_name = "all",
                              colors_omics = colors_omics)
mrna_pos_1_vis <- vis_load_ord(gl_f_ord = mrna_pos_1, omic_name = "mrna",
                               colors_omics = colors_omics)

ggarrange(all_pos_1_vis, mrna_pos_1_vis)
```

#### Factor 2

Here, we return and visualize two ranked lists for Factor 2: using all omics,
or just protein, this time ranking features by magnitude (absolute value).

```{r part-2-factor-2, fig.dim = c(10, 5)}
# define the loadings
all_abs_2 <- ord_loadings(mcia_out = mcia_results, omic = "all",
                          absolute = TRUE, descending = TRUE, factor = 2)
prot_abs_2 <- ord_loadings(mcia_out = mcia_results, omic = "prot",
                           absolute = TRUE, descending = TRUE, factor = 2)

# visualization
all_abs_2_vis <- vis_load_ord(gl_f_ord = all_abs_2, omic_name = "all",
                              colors_omics = colors_omics)
prot_abs_2_vis <- vis_load_ord(gl_f_ord = prot_abs_2, omic_name = "prot",
                               colors_omics = colors_omics)

ggarrange(all_abs_2_vis, prot_abs_2_vis)
```

#### Factor 4

We return and visualize a ranked list for Factor 4 with the top 60 features.
One can observe that while miRNA dominate the top features, all omics are
represented.

```{r part-2-factor-4, fig.dim = c(10, 4)}
# define the loadings
all_4 <- ord_loadings(mcia_results, omic = "all", absolute = FALSE,
                      descending = TRUE, factor = 4)

# visualization
all_4_plot <- vis_load_ord(gl_f_ord = all_4, colors_omics = colors_omics,
                           n_feat = 60)
all_4_plot
```

### Pathway Analysis for the Top Factors using Data from Gene-Centric Omics Blocks

The NCI60 data set includes gene expression data and its corresponding global
loading matrix is a gene by factor matrix. We can learn more about the pathways
a given factor may be capturing by running each factor vector (column of the
global loadings matrix) through a gene set enrichment analysis (GSEA). In the
previous sections we saw how much each mRNA factor is contributing to the MCIA
decomposition and so we will focus on factors X, Y, Z. We will run
`gsea_report()` which reports on the p-value of the most significant pathway as
well as the total number of significant pathways for each factor. Finally the
report will summarize all factors using the selectivity score as described by
Cantini et al., 2021 (more details below).

#### Gather Data and Generate the Report

```{r part-2-pathways, warning = FALSE}
# extract mRNA global loadings
mrna_gfscores <- mcia_results$global_loadings
mrna_rows <- str_detect(row.names(mrna_gfscores), "_mrna")
mrna_gfscores <- mrna_gfscores[mrna_rows, ]

# rename rows to contain HUGO based gene symbols
row.names(mrna_gfscores) <- str_remove(rownames(mrna_gfscores), "_[0-9]*_.*")

# load pathway data
path.database <- "https://data.broadinstitute.org/gsea-msigdb/msigdb/release/6.2/c2.cp.reactome.v6.2.symbols.gmt"
pathways <- fgsea::gmtPathways(path.database)

# generate the GSEA report
geneset_report <- gsea_report(mrna_gfscores, path.database,
                             factors = seq(1, 3), pval.thr = 0.05, nproc = 8)
```

#### Investigating the GSEA Summary Table

The report comes in the form of a list where the first element is a data frame
with summary level of the GSEA analysis per factor. Ideally, each factor is
capturing a very select number of pathways with a high significance. From this
report (below) we can see that the most significant pathway is associated with
Factor3 and that there is a large variation in the number of total (significant)
pathways ranging from 7 (Factor 8) to 143 (Factor 4).

```{r part-2-genesets}
geneset_report[[1]]
```

As just mentioned, Factor3 contains the most enrichment gene set so we can
re-run GSEA for this factor in order to get a full list of enrichment scores
across all gene sets:

```{r part-2-gsea-for-factor-3, warning = FALSE}
# re-running GSEA
factor3_paths <- fgseaMultilevel(pathways, mrna_gfscores[, 3],
                                 nPermSimple = 10000, minSize = 15,
                                 nproc = 4, maxSize = 500)
factor3_paths
```

If we extract the most significant gene set (below) we can see that the
REACTOME_CELL_CYCLE gene set comes up which makes sense given that the NCI60
data set is studying cancer. This analysis can be repeated as necessary to make
sense of other gene based factor loadings.

```{r part-2-significant}
# extracting to most significant gene set
sig_path3 <- factor3_paths[min(factor3_paths$pval) == factor3_paths$pval, ][1, ]

as.list(sig_path3)
```

## Session Info

```{r session-info}
sessionInfo()
```